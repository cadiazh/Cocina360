{% extends "base.html" %}
{% block title %}{{ recipe.name }} - Cocina 360{% endblock %}

{% block extra_head %}
<style>

/* --- LAYOUT --- */
.layout {
    display: flex;
    gap: 25px;
    margin-top: 20px;
}

/* --- SIDEBAR --- */
.sidebar a {
    color: #ff7a00;
    font-weight: 600;
    text-decoration: none;
    font-size: 1.1rem;
}

.sidebar a:hover {
    text-decoration: underline;
}

/* --- CARD --- */
.card {
    background: white;
    padding: 30px;
    border-radius: 14px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.08);
}

/* TITULO */
.card h1 {
    font-size: 2rem;
    margin-bottom: 10px;
    color: #333;
    border-bottom: 3px solid #ff7a00;
    padding-bottom: 6px;

    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* FAVORITOS */
.favorite-btn {
    font-size: 2rem;
    background: none;
    border: none;
    cursor: pointer;
    color: #bbb;
    transition: .25s;
}

/* ‚≠ê CAMBIO 1: Coraz√≥n rojo para el estado 'favorited' */
.favorite-btn.favorited {
    color: #ff3b3b; /* Color rojo para favorito */
    transform: scale(1.2);
}

.favorite-btn:hover {
    color: #ff7a00;
}

/* SUBT√çTULOS */
.card h2 {
    margin-top: 25px;
    font-size: 1.4rem;
    color: #444;
    border-left: 5px solid #ff7a00;
    padding-left: 10px;
}

/* --- INGREDIENTES --- */
.ingredients-list {
    margin-top: 15px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.ingredient-card {
    display: flex;
    align-items: flex-start;
    gap: 14px;
    padding: 12px 14px;
    background: #fff2e6;
    border: 2px solid #ffb366;
    border-radius: 10px;
}

.ingredient-check {
    width: 22px;
    height: 22px;
    accent-color: #ff7a00;
    margin-top: 4px;
}

.ingredient-text {
    flex: 1;
    font-size: 1.05rem;
    line-height: 1.4;
}

.ingredient-text.completed {
    text-decoration: line-through;
    color: #777;
    font-style: italic;
}

/* --- PASOS --- */
.steps-list {
    margin-top: 15px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* ‚≠ê CLAVE: Asegura la alineaci√≥n horizontal de checkbox y texto */
.step-card {
    display: flex; 
    align-items: flex-start; /* Alinea los elementos a la parte superior */
    gap: 14px; 
    padding: 12px 14px;
    background: #fff2e6;
    border: 2px solid #ffb366;
    border-radius: 10px;
}

/* ‚≠ê CAMBIO 2: Ocultar el n√∫mero de paso grande que causaba el problema de alineaci√≥n */
.step-number {
    display: none; /* OCULTAR */
}

.step-check {
    width: 22px;
    height: 22px;
    accent-color: #ff7a00;
    margin-top: 4px;
}

.step-text {
    flex: 1;
    font-size: 1.05rem;
    line-height: 1.4;
}

.step-text.completed {
    text-decoration: line-through;
    color: #777;
    font-style: italic;
}

/* --- CHAT --- */
.chat-box {
  margin-top: 40px;
  background: #fff6ee;
  border-radius: 12px;
  border: 1px solid #ffddc2;
  overflow: hidden;
  max-height: 400px;
  display: flex;
  flex-direction: column;
}

.chat-header {
  background: #ff7a00;
  color: white;
  padding: 10px 15px;
  font-weight: 600;
}

.messages {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
}

.bubble {
  max-width: 75%;
  padding: 10px 14px;
  border-radius: 10px;
  margin-bottom: 10px;
  white-space: pre-wrap;
}

.bubble.user {
  margin-left: auto;
  background: #ff7a00;
  color: white;
}

.bubble.bot {
  background: #ffe9d6;
  color: #333;
}

.chat-footer {
  padding: 10px;
  border-top: 1px solid #ffddc2;
  display: flex;
  gap: 8px;
}

.chat-footer textarea {
  flex: 1;
  resize: none;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #ffddc2;
}

.chat-footer button {
  background: #ff7a00;
  color: white;
  border: none;
  padding: 10px 18px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
}

.chat-footer button:hover {
  background: #e06600;
}

</style>
{% endblock %}


{% block content %}

<div class="layout">

        <div class="sidebar">
      <a href="{% url 'recipe_list' %}">‚Üê Volver</a>
    </div>

    <div style="flex: 1;">

      <div class="card">

                <h1>
         {{ recipe.name }}

         {% if user.is_authenticated %}
         <form action="{% url 'toggle_favorite' pk=recipe.pk %}" method="post">
            {% csrf_token %}
            {% if recipe.pk in favorite_recipe_ids %}
              <button class="favorite-btn favorited">‚ô•</button>
            {% else %}
              <button class="favorite-btn">‚ô°</button>
            {% endif %}
         </form>
         {% endif %}
        </h1>
        <a href="{% url 'recipe_pdf' recipe.pk %}"
          class="btn btn-secondary"
          style="margin-bottom: 15px; display:inline-block;">
          üìÑ Descargar receta en PDF
        </a>


        <p><strong>Tiempo de preparaci√≥n:</strong> {{ recipe.preparation_time }} minutos</p>

        {% if recipe.min_portion or recipe.max_portion %}
        <p><strong>Porciones:</strong>
          {% if recipe.min_portion %}{{ recipe.min_portion }}{% endif %}
          {% if recipe.max_portion %} - {{ recipe.max_portion }}{% endif %}
        </p>
        {% endif %}


                <h2>Ingredientes</h2>

        <div class="ingredients-list">
            {% for item in ingredients_with_status %}
                {% if item.ingredient.name.strip %}
                <div class="ingredient-card">

                    <form action="{% url 'toggle_ingredient_completion' recipe_pk=recipe.pk ingredient_pk=item.ingredient.pk %}"
                          method="post">
                        {% csrf_token %}
                        <input type="checkbox"
                              class="ingredient-check"
                              {% if item.completed %}checked{% endif %}
                              onchange="this.form.submit()">
                    </form>

                    <div class="ingredient-text {% if item.completed %}completed{% endif %}">
                        {{ item.ingredient.name }}
                    </div>

                </div>
                {% endif %}
            {% endfor %}
        </div>


                <h2>Pasos</h2>

        <div class="steps-list">
            {% for item in steps_with_status %}
                {% if item.cleaned_description.strip %}
                <div class="step-card">

                    <form action="{% url 'toggle_step_completion' recipe_pk=recipe.pk step_pk=item.step.pk %}"
                          method="post">
                        {% csrf_token %}
                        <input type="checkbox"
                              class="step-check"
                              {% if item.completed %}checked{% endif %}
                              onchange="this.form.submit()">
                    </form>

                    <div class="step-text {% if item.completed %}completed{% endif %}">
                        {{ item.cleaned_description }}
                    </div>

                </div>
                {% endif %}
            {% endfor %}
        </div>


                <div class="chat-box">
          <div class="chat-header">üë©‚Äçüç≥ Asistente de Cocina</div>

          <div id="chat-messages" class="messages">
            <div class="bubble bot">
              Hola üëã Soy tu asistente de cocina. Preg√∫ntame algo sobre esta receta.
            </div>
          </div>

          <div class="chat-footer">
            <textarea id="chat-input" placeholder="Escribe tu pregunta..."></textarea>
            <button id="chat-send">Enviar</button>
          </div>
        </div>

      </div>
    </div>
</div>


<script>
const chatBox = document.getElementById("chat-messages");
const chatInput = document.getElementById("chat-input");
const chatSend = document.getElementById("chat-send");

function addBubble(text, who) {
  const div = document.createElement("div");
  div.className = "bubble " + who;
  div.textContent = text;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

async function sendMessage() {
  const msg = chatInput.value.trim();
  if (!msg) return;

  addBubble(msg, "user");
  chatInput.value = "";

  const response = await fetch("{% url 'recipe_chat' %}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      message: msg,
      recipe_id: "{{ recipe.pk }}"
    })
  });

  const data = await response.json();
  addBubble(data.reply, "bot");
}

chatSend.onclick = sendMessage;

chatInput.onkeydown = (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
};
</script>

{% endblock %}
