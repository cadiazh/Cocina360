{% extends "base.html" %}

{% block title %}Nueva Receta - Cocina 360{% endblock %}

{% block extra_head %}
<style>
/* --- LAYOUT --- */
.layout {
    display: flex;
    gap: 25px;
    margin-top: 20px;
}
#ingredients-fieldset label {
            font-size: 1.2rem;  /* Tama√±o m√°s grande */
            font-weight: bold;  /* Negrita */
            color: #333;        /* Color de texto (opcional) */
        }

/* --- CARD PRINCIPAL --- */
.card {
    background: white;
    padding: 30px;
    border-radius: 14px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.08);
    font-family: Arial, sans-serif; /* Aseguramos que la fuente sea consistente */
}

/* TITULO DE LA CARD */
.card h1 {
    font-size: 2rem;
    margin-bottom: 10px;
    color: #333;
    border-bottom: 3px solid #ff7a00;
    padding-bottom: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* SUBT√çTULOS DE LA CARD */
.card h2 {
    margin-top: 25px;
    font-size: 1.9rem;
    color: #444;
    border-left: 5px solid #ff7a00;
    padding-left: 10px;
}

/* --- FORMULARIO --- */
.form-row {
    margin-bottom: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

label {
    font-size: 1.4rem;
    color: #333;
    font-weight: bold;
    font-family: Arial, sans-serif; /* Aseguramos que la fuente sea consistente */
}

input, select, textarea {
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 1rem;
    font-family: Arial, sans-serif; /* Aseguramos que la fuente sea consistente */
}

input[type="checkbox"] {
    margin-top: 6px;
}

/* --- INGREDIENTES --- */
.ingredients-list {
    margin-top: 15px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.ingredient-card {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 12px 14px;
    background: #fff2e6;
    border: 2px solid #ffb366;
    border-radius: 10px;
    transition: transform 0.3s ease-in-out;
}

.ingredient-card:hover {
    transform: scale(1.03); /* Efecto hover para agrandar la card */
}

.ingredient-check {
    width: 22px;
    height: 22px;
    accent-color: #ff7a00;
    margin-top: 4px;
}

.ingredient-text {
    flex: 1;
    font-size: 1.05rem;
    line-height: 1.4;
    font-family: Arial, sans-serif; /* Aseguramos que la fuente sea consistente */
}

.ingredient-text.completed {
    text-decoration: line-through;
    color: #777;
    font-style: italic;
}

/* --- PASOS --- */
.steps-list {
    margin-top: 15px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.step-card {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 12px 14px;
    background: #fff2e6;
    border: 2px solid #ffb366;
    border-radius: 10px;
    transition: transform 0.3s ease-in-out;
}

.step-card:hover {
    transform: scale(1.03); /* Efecto hover para agrandar la card */
}

.step-check {
    width: 22px;
    height: 22px;
    accent-color: #ff7a00;
    margin-top: 4px;
}

.step-text {
    flex: 1;
    font-size: 1.05rem;
    line-height: 1.4;
    font-family: Arial, sans-serif; /* Aseguramos que la fuente sea consistente */
}

.step-text.completed {
    text-decoration: line-through;
    color: #777;
    font-style: italic;
}

/* --- BOT√ìN PUBLICAR --- */
.publish-btn {
    background-color: #ff9800;
    color: white;
    padding: 10px 20px; /* Tama√±o m√°s peque√±o para el bot√≥n */
    border-radius: 6px;
    font-weight: bold;
    border: none;
    cursor: pointer;
    font-size: 1rem; /* Ajuste al tama√±o adecuado */
    transition: background-color 0.3s;
    margin-top: 20px; /* A√±adimos espacio entre el formulario y el bot√≥n */
    font-family: Arial, sans-serif; /* Aseguramos que la fuente sea consistente */
}

.publish-btn:hover {
    background-color: #e68900;
}

/* --- BOTONES ELIMINAR --- */
.remove-btn {
    margin-top: 8px;
    background-color: #ff0000;
    color: white;
    padding: 10px 20pX;
    text-decoration: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    width: auto; 
    font-family: Arial, sans-serif;
    margin-left: auto;
    margin-right: auto;
}

.remove-btn:hover {
    background-color: #e68900;
    width: auto; 
}

.remove-btn {
    text-align: left; /* Alineamos el bot√≥n a la izquierda */
    font-size: 0.9rem; /* Tama√±o de fuente m√°s peque√±o */
    padding: 10px 20px; 
    width: auto; 
    background-color: #cc3300; /* Rojo */
}

.remove-btn:hover {
    background-color: #992200;
    width: auto; 
}

.add-btn {
    background-color: #ff9800;
    color: white;
    padding: 10px 20px; /* Tama√±o m√°s peque√±o para el bot√≥n */
    border-radius: 6px;
    font-weight: bold;
    border: none;
    cursor: pointer;
    font-size: 1rem; /* Ajuste al tama√±o adecuado */
    transition: background-color 0.3s;
    margin-top: 20px; /* A√±adimos espacio entre el formulario y el bot√≥n */
}


</style>
{% endblock %}

{% block content %}
<div class="layout">
    <div class="sidebar">
        <a href="{% url 'recipe_list' %}" class="orange-link">‚Üê Volver</a>
    </div>

    <div style="flex: 1;">
        <div class="card">
            <h1>Publicar Nueva Receta</h1>

            <form method="post" id="recipe-form">
                {% csrf_token %}

                <!-- Nombre -->
                <div class="form-row">
                    <label for="{{ form.name.id_for_label }}">Nombre:</label>
                    {{ form.name }}
                </div>

                <!-- Tiempo de Preparaci√≥n -->
                <div class="form-row">
                    <label for="{{ form.preparation_time.id_for_label }}">Tiempo de Preparaci√≥n:</label>
                    {{ form.preparation_time }}
                </div>

                <!-- Porci√≥n M√≠nima -->
                <div class="form-row">
                    <label for="{{ form.min_portion.id_for_label }}">Porci√≥n M√≠nima:</label>
                    {{ form.min_portion }}
                </div>

                <!-- Porci√≥n M√°xima -->
                <div class="form-row">
                    <label for="{{ form.max_portion.id_for_label }}">Porci√≥n M√°xima:</label>
                    {{ form.max_portion }}
                </div>

                <!-- INGREDIENTES -->
                <fieldset id="ingredients-fieldset">
                    <legend>Ingredientes</legend>
                    {{ ingredient_formset.management_form }}
                     <div id="ingredients-forms">
                        {% for form in ingredient_formset %}
                            <div class="form-row">
                                {{ form.name.label_tag }} {{ form.name }}
                                {{ form.DELETE }}  <!-- oculto por CSS -->
                                <button type="button" class="remove-btn" onclick="removeForm(this)">Eliminar Ingrediente</button>
                            </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="add-btn" onclick="addForm('ingredients')">+ Agregar Ingrediente</button>
                </fieldset>

                <!-- PASOS -->
                <fieldset id="steps-fieldset">
                    <legend>Pasos</legend>
                    {{ step_formset.management_form }}
                    <div id="steps-forms">
                        {% for form in step_formset %}
                            <div class="form-row step-row">
                                {{ form.order }} <!-- se rellena autom√°ticamente -->
                                {{ form.description.label_tag }} {{ form.description }}
                                {{ form.DELETE }} <!-- oculto -->
                                <button type="button" class="remove-btn" onclick="removeForm(this)">Eliminar Paso</button>
                            </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="add-btn" onclick="addForm('steps')">+ Agregar Paso</button>
                </fieldset>

                <!-- BOT√ìN PUBLICAR RECETA -->
                <button type="submit" class="publish-btn">Publicar Receta</button>
            </form>

            <p><a href="{% url 'recipe_list' %}" class="back-link">‚Üê Volver a las recetas</a></p>
        </div>
    </div>
</div>

{% endblock %}

<script>
    function removeForm(button) {
        const formRow = button.closest('.form-row');
        const deleteInput = formRow.querySelector('input[type=checkbox][name$="-DELETE"]');
        if (deleteInput) {
            deleteInput.checked = true;
            formRow.style.display = 'none';
        } else {
            formRow.remove();
        }
        updateFormIndices();
    }

    function addForm(prefix) {
        const formsDiv = document.getElementById(prefix + '-forms');
        const totalFormsInput = document.querySelector(`#id_${prefix}-TOTAL_FORMS`);
        const currentFormCount = parseInt(totalFormsInput.value);
        const emptyFormTemplate = document.getElementById(prefix + '-empty-form').innerHTML;

        const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, currentFormCount);
        const tempDiv = document.createElement('div');
        tempDiv.classList.add('form-row');
        if (prefix === 'steps') tempDiv.classList.add('step-row');
        tempDiv.innerHTML = newFormHtml + `
            <button type="button" class="remove-btn" onclick="removeForm(this)">Eliminar</button>
        `;

        formsDiv.appendChild(tempDiv);
        totalFormsInput.value = currentFormCount + 1;
        updateFormIndices();
    }

    function updateFormIndices() {
        ['ingredients', 'steps'].forEach(prefix => {
            const formsDiv = document.getElementById(prefix + '-forms');
            const totalFormsInput = document.querySelector(`#id_${prefix}-TOTAL_FORMS`);
            const forms = formsDiv.querySelectorAll('.form-row:not([style*="display: none"])');
            totalFormsInput.value = forms.length;
            forms.forEach((formRow, index) => {
                formRow.querySelectorAll('input, select, textarea, label').forEach(el => {
                    if (el.name) {
                        el.name = el.name.replace(new RegExp(`${prefix}-\\d+`), `${prefix}-${index}`);
                    }
                    if (el.id) {
                        el.id = el.id.replace(new RegExp(`${prefix}-\\d+`), `${prefix}-${index}`);
                    }
                    if (el.htmlFor) {
                        el.htmlFor = el.htmlFor.replace(new RegExp(`${prefix}-\\d+`), `${prefix}-${index}`);
                    }
                });
                // üî• Auto enumerar Steps
                if (prefix === 'steps') {
                    const orderInput = formRow.querySelector('input[name$="-order"]');
                    if (orderInput) orderInput.value = index + 1;
                }
            });
        });
    }
</script>

<!-- Empty form templates -->
<div id="ingredients-empty-form" style="display:none;">
    <label for="id_ingredients-__prefix__-name">Nombre:</label>
    <input type="text" name="ingredients-__prefix__-name" id="id_ingredients-__prefix__-name" />
    <input type="checkbox" name="ingredients-__prefix__-DELETE" id="id_ingredients-__prefix__-DELETE" />
</div>

<div id="steps-empty-form" style="display:none;">
    <input type="hidden" name="steps-__prefix__-order" id="id_steps-__prefix__-order" value="__order__" />
    <label for="id_steps-__prefix__-description">Descripci√≥n:</label>
    <textarea name="steps-__prefix__-description" id="id_steps-__prefix__-description"></textarea>
    <input type="checkbox" name="steps-__prefix__-DELETE" id="id_steps-__prefix__-DELETE" />
</div>

</body>
</html>


